

流程

1. 功能分析 : 讨论完成
2. 架构 : 讨论完成
3. 代码 : 功能或模块划分(顺序, 时间点, 优先级, 周计划)
4. 测试 : 略


## 网盘

### 功能分析

1. 登陆注册

   支持多用户

2. 上传

   大文件的快速上传
   多个小文件的上传
   实现秒传

3. 下载

   大文件的快速下载
   多个小文件的上传下载

4. 文件增量与文件时光机

### 概要及详细设计

客户端

1. 登陆与注册

   用户名与密码
   加密

   1. 用户名校验

        用户名格式 : 正则表达式

   2. 密码强度判断

        1. 纯数字: 正则
        2. 数字和字母组合 : 正则
        3. 数字和大小写字面组合 : 正则

   3. 验证码

        随机数 : 略
        图片 :
        数值运算 : 略
        短信验证 : 略
        拖动验证 : 略

   4. 加密: Https (TLS SSL) ?

   实现: HTTP GET + POST

   备注 : HTTP : GET POST PUT DELTE

2. 上传

   大文件快速上传 : 分块
   多个小文件快速上传: 线程池, 根据文件类型进行确定分块
   秒传: 分块 + md5 校验; 视频, 图片
   增量 : 分块 + 只上传修改的分块 + 分块列表版本号化
   时光机: 分块列表版本号化

   0. 初次登陆获取获取所有元数据: 数据库获取所有文件元数据
   1. 如果上传已经存在的文件名, 文件名增加后缀, 或提示用户覆盖
   2. 对文件进行分块, 生成分块列表, 保存分块列表
      保存: 数据库, 关系型数据库, NoSql)
      表结构: 分块名称, id, md5, 版本号
   3. 上传分块列表(包含版本号), 获取服务端返回需要上传的分块列表 (HTTP POST)
   4. 将分块列表的文件加入队列, 线程池中的每个线程(任务)从队列中取数据,
      获取上传文件分块路径上传(零拷贝 + HTTP POST), 服务器返回成功列表
      如果失败, 重传失败列表(多次重试)

    注 : 注意区别分块列表和分块列表的文件两者之间的区别

3. 下载

    大文件下载 : 分块 + 历史版本元数据 + 分块列表
    多个小文件快速下载 : 见上

    1. 获取文件的分块列表
    2. 保存文件版本信息
    2. 将分块列表的文件加入队列, 线程池中的每个线程(任务)从队列中取数据,
       下载对应分块
    3. 将各个分块合并

    元数据(MetaData): 文件的分块列表(各个历史版本)

服务端

1. 登陆与注册

   用户名与密码
   加密

   1. 用户名校验

        用户名格式 : 正则表达式
        重名检查 : 检查

   2. 密码强度判断

        1. 纯数字: 正则
        2. 数字和字母组合 : 正则
        3. 数字和大小写字面组合 : 正则

   3. 验证码

        随机数 : 略
        图片 :
        数值运算 : 略
        短信验证 : 略
        拖动验证 : 略

    注册
    1. 用户名检验(格式, 是否存在等)
    2. 密码强度判断
    3. 校验码验证
    4. 保存注册用户数据(数据库, 用户名, 密码, 创建时间等等)

    登陆
    1. 用户名 + 密码验证(格式, 是否存在等)
    2. 校验码验证

2. 上传

    登陆验证: session 或 token_id 验证

    大文件快速上传 :

    1. 验证文件是否存在;
       如果不存在就创建对应的元数据到元数据服务器, 返回全部分块列表;
       如果存在, 校验版本号(客户端版本号必须比服务端大一个版本),
       与服务端最大版本号分块列表对比, 将新版本的元数据(分块列表信息)存储
       到元数据服务器, 返回不存在的分块列表;
    2. 接受客户端上传的文件,
       保存分块到(分布式文件系统 hadoop, 分布式对象存储(Ceph, Swift))
    3. 从元数据服务器获取元数据, 对分块信息校验(版本号等), 校验成功
       保存分块信息.

    注:
       元数据服务器: 保存所有文件信息的服务器
       分布式存储: 保存文件系统
       URL : /filename/id

    要点:
    Rsync : Mark Adler, adler-32 算法

2. 下载

   1. 查询文件的分块列表返回给客户端
   2. 将对应的文件分块列表发送给客户端(零拷贝)

### 架构

   1. 客户端 : 略

   2. 服务端

    并发连接

        netty 库

    海量数据

        1. 数据备份(几个备份)
        2. 分布式存储(查询)
        3. 高可用(HA)


## 微信红包

### 功能分析

1. 登陆注册

2. 发红包

用户管理 : 见注册登陆

* 创建一个用户
* 删除一个用户
* 充值
* 单个用户只能领取一次
* 加好友
* 删除好友

红包管理

* 创建一个红包
* 超时未领取

群红包

* 创建群
* 拉群 : 把别人拉到群里面
* 加群 : 主动加到群里面
* 退群 : 主动退群
* 被踢 : 群管理员将任意群友(不包括自己)踢出群
* 群发 : 随机, 均分, 最佳手气
* 群搜索功能 : 根据群号找到一个群

好友红包

* 一对一发 : 定额

消息

* 文字消息
* 红包

### 概要及详细设计

1. 登陆与注册

见上

2. 用户管理

* 创建和删除一个用户

    关键属性 : 用户名, 密码, 余额, 好友列表, 群列表, 红包列表(已发, 已收), 消息列表

* 单个用户只能领取一次 :

    红包的金额列表包含用户 id, 将红包分配给用户之前, 校验当前用户是否已经
    在红包列表. 如果在, 返回已领取, 如果不在, 分配给用户

3. 红包管理

* 创建一个红包 : 未领取金额队列, 已领取金额队列, 创建时间, 有效时间
* 超时未领取 : 当前时间超过过期时间(创建时间+有效时间), 余额返回给用户

4. 群红包

* 创建群: 群成员列表, 群主, 消息列表地址
* 拉群 : 把好友加到一个群里面
* 加群 : 群主审核(可选), 根据群号搜索到群, 发送加群请求给群主, 审核, 过/不过
* 退群 : 更新用户和群的对应列表
* 被踢 : 群主发送要删除用户, 更新用户和群的对应列表
* 群发 :

    1. 随机 : 根据总金额和个数随机分配每个红包; 一分钱下限, 红包算法(公平!!!!)

       发红包: 从用户余额扣除, 创建红包;
       分红包: 计算红包为领取金额列表: [0 - M/N * 2] : M 剩余金额; N 剩余红包个数(数学证明)
       抢红包: 打乱顺序放到红包队列, 先到先服务, 前 N 个从红包金额列表
              依次取金额, 加入对应用户的余额中, 将该金额加入红包的已领取
              队列, 后续没有抢到用户返回
              统一消息(优化点)

              注意点: 参加单用户只能领取一个红包

       超时未领取 : 当前时间超过过期时间(创建时间+有效时间), 余额返回给用户

    2. 定额分配 : M/N 见上(优化点, 缓存)

5. 好友红包

* 一对一发 : 定额

    发红包: 从用户余额扣除, 创建红包;
    收红包: 如果好友收红包, 好友余额加指定金额
    超时未领取 : 当前时间超过过期时间(创建时间+有效时间), 余额返回给用户

    超时未领取精确时间返回给用户? 排序队列＋线程池 (用户检查过期时间,
            给服务器发消息, 服务器 epoll 监听)

* 群搜索功能 : 遍历群列表(少 HashMap, 分布式存储), (优化点)

6. 消息

   关键属性: 消息列表(文字消息, 红包消息 id)

   * 文字消息
   * 红包 : 关键属性: 红包数量, 金额列表

### 架构

   见上

## 搜索引擎

### 概要及详细设计

1. 数据获取

主题 : 找个某一个或几个细分领域, 提供搜索服务

* 博客

分布式的爬虫框架

* 调研爬虫框架(两周): 易用性, 成熟度, 活跃度, 稳定性
* 原理分析
* 爬虫

2. 建索引

* 分布式队列 : 文章列表 (可选)
* 分布式计算 : Hadoop(MapReduce, Spark), Elasticsearch(开源的搜索引擎), Solr : Lucene
* 分布式存储 : MongoDB, HDFS

计算:

* 分词: 中文和英文分词; github
* 倒排索引
* 去重
* 计算相似度
* 文本分类

3. 搜索

* 基于关键字搜索
* 搜索结果结果字高亮
* 搜索热词 : Top N 算法 (亮点)
* 即时搜索 : Trie 树(亮点)
* 自动纠错 : 模糊匹配

4. 搜索质量评估: (亮点)

参考: 知网, 论文
